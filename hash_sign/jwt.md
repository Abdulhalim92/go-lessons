# Шифрование и JWT (JSON Web Tokens)

**Шифрование** и **JWT (JSON Web Tokens)** — важные концепции в области 
безопасности данных и аутентификации в веб-приложениях. Шифрование используется 
для защиты данных от несанкционированного доступа, в то время как JWT 
предоставляет стандартный способ безопасной передачи информации между сторонами в
формате JSON.

## Шифрование

Шифрование — это процесс преобразования информации (открытого текста) в
зашифрованный формат (шифртекст), который может быть прочитан только с 
использованием специального ключа. Шифрование используется для защиты данных,
передаваемых или хранящихся в небезопасной среде.

- **Симметричное шифрование**: Использует один и тот же ключ для шифрования и 
дешифрования данных. Примеры алгоритмов: AES (Advanced Encryption Standard),
DES (Data Encryption Standard).

- **Асимметричное шифрование**: Использует два ключа — публичный ключ для 
шифрования и приватный ключ для дешифрования. Примеры алгоритмов: RSA, ECC
(Elliptic Curve Cryptography).

## JWT (JSON Web Tokens)

**JWT** — это стандарт (RFC 7519) для безопасной передачи данных между сторонами в
виде JSON-объекта. JWT часто используется для аутентификации и авторизации в 
веб-приложениях.

### Структура JWT

JWT состоит из трех частей, разделенных точками (`.`):

1. **Header (Заголовок)**: Содержит метаданные о токене, такие, как тип токена 
(`JWT`) и алгоритм шифрования или подписи, например, `HS256` или `RS256`.

   ```json
   {
     "alg": "HS256",
     "typ": "JWT"
   }
   ```
   
2. **Payload (Полезная нагрузка)**: Содержит данные, которые нужно передать.
Обычно в полезной нагрузке передаются такие данные, как user_id, role и другие
утверждения. Эти данные не шифруются и могут быть прочитаны любым, кто имеет 
доступ к токену, поэтому важно не включать в полезную нагрузку чувствительную
информацию.

   ```json
   {
      "sub": "1234567890",
      "name": "John Doe",
      "admin": true
    }
   ```
   
3. **Signature (Подпись)**: Подпись создается путем применения алгоритма, 
указанного в заголовке (например, HMAC SHA256), к заголовку и полезной нагрузке
токена. Она используется для проверки подлинности токена и его целостности.

    ```scss
    HMACSHA256(
    base64UrlEncode(header) + "." +
    base64UrlEncode(payload),
    secret)
    ```

### Как работает JWT

1. **Создание токена**: Когда пользователь успешно проходит аутентификацию, сервер
создает JWT, содержащий определенные утверждения, и подписывает его своим 
секретным ключом.

2. **Передача токена**: Токен отправляется пользователю, обычно через заголовки
HTTP (например, в заголовке `Authorization: Bearer <token>`).

3. **Использование токена**: При последующих запросах клиент отправляет этот токен,
и сервер проверяет его подлинность и целостность, чтобы решить, разрешить или 
отклонить запрос.

### Преимущества JWT

- **Безопасность**: Токены подписываются, что обеспечивает защиту от 
несанкционированного изменения данных.

- **Масштабируемость**: JWT не требует сохранения состояния на сервере. Все
необходимое для проверки подлинности содержится в самом токене.

- **Простота интеграции**: JWT может использоваться в веб-приложениях, мобильных
приложениях и микросервисах.

# Реализация JWT на Go

Для реализации JWT в Go используется библиотека 
[`github.com/golang-jwt/jwt/v5`](https://pkg.go.dev/github.com/golang-jwt/jwt/v5). Давайте посмотрим на пример кода, который создаст и проверит JWT токен.

## Пример кода для работы с JWT в Go

```go
package utils

import (
	"fmt"
	"time"

	"github.com/golang-jwt/jwt/v5"
)

// Секретный ключ для подписи токенов (держите его в секрете)
var jwtSecret = []byte("your_secret_key")

// GenerateJWT создает новый JWT токен для пользователя
func GenerateJWT(username string) (string, error) {
	// Определяем срок действия токена
	expirationTime := time.Now().Add(24 * time.Hour)

	// Создаем токен с помощью стандарта HMAC и алгоритма подписи
	claims := &jwt.MapClaims{
		"username": username,
		"exp":      expirationTime.Unix(),
	}

	// Создание токена с подписью
	token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)

	// Подписание токена с использованием секретного ключа
	tokenString, err := token.SignedString(jwtSecret)
	if err != nil {
		return "", err
	}

	return tokenString, nil
}

// ValidateJWT проверяет валидность JWT токена
func ValidateJWT(tokenString string) (string, error) {
	// Парсинг и проверка токена
	token, err := jwt.Parse(tokenString, func(token *jwt.Token) (interface{}, error) {
		// Проверка алгоритма подписи
		if _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok {
			return nil, fmt.Errorf("unexpected signing method: %v", token.Header["alg"])
		}
		return jwtSecret, nil
	})

	if err != nil {
		return "", err
	}

	// Проверка валидности токена и извлечение данных
	if claims, ok := token.Claims.(jwt.MapClaims); ok && token.Valid {
		username := claims["username"].(string)
		return username, nil
	}

	return "", fmt.Errorf("invalid token")
}

// ExampleV1 демонстрирует пример использования JWT
func ExampleV1() {
	// Пример использования
	username := "john_doe"

	// Создание JWT токена
	token, err := GenerateJWT(username)
	if err != nil {
		fmt.Println("Ошибка при создании JWT:", err)
		return
	}

	fmt.Println("Создан JWT токен:", token)

	// Проверка JWT токена
	validUsername, err := ValidateJWT(token)
	if err != nil {
		fmt.Println("Ошибка при проверке JWT:", err)
		return
	}

	fmt.Println("Имя пользователя из валидного токена:", validUsername)
}
```

## Объяснение кода

### Секретный ключ (`jwtSecret`)
Этот ключ используется для подписи токена и должен храниться в секрете. Никогда не
размещайте его в открытом доступе.

### Функция `GenerateJWT`
- Создает новый JWT токен с заданным `username` и сроком действия.
- Использует метод `jwt.NewWithClaims` для создания токена с заданными 
утверждениями (`username` и `exp` — время истечения срока действия).
- Подписывает токен с использованием HMAC SHA256 алгоритма и секретного ключа.

### Функция `ValidateJWT`
- Проверяет валидность токена, используя метод `jwt.Parse`.
- Проверяет, что токен был подписан с использованием ожидаемого алгоритма (HMAC).
- Возвращает имя пользователя, если токен валиден.

### Функция `ExampleV1`
Пример использования функций `GenerateJWT` и `ValidateJWT` для создания и 
проверки токена.

## Примечания по безопасности

- **Секретный ключ** должен быть защищен и не должен быть доступен сторонним 
лицам.
- **Время истечения срока действия токена (`exp`)** должно быть установлено 
разумным для минимизации риска использования скомпрометированного токена.
- **Хранение токена** на стороне клиента должно быть безопасным (использование
безопасных куков или другого защищенного хранилища).

## Заключение

Использование JWT — популярный и эффективный способ обеспечения безопасности в 
веб-приложениях. Он позволяет аутентифицировать пользователей и безопасно 
передавать данные между клиентом и сервером. Пример на Go демонстрирует, как
легко интегрировать JWT в ваше приложение, используя библиотеку
[`github.com/golang-jwt/jwt/v5`](https://pkg.go.dev/github.com/golang-jwt/jwt/v5).
